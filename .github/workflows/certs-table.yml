name: Build certs table

on:
  push:
    branches:
      - master
    paths:
      - 'certs.yaml'

permissions:
  contents: write

jobs:
  build-table:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate Markdown table from YAML
        id: table
        uses: gazab/create-markdown-table@v1
        with:
          file: ./certs.yaml
          columns: '["ContentId","Area","PageTitle","MetaDescription"]'

      - name: Update README with notice and table
        run: |
          TABLE="${{ steps.table.outputs.table }}"
          CONTENT="$(cat README.md)"

          NOTICE=$'\n> Disclaimer\n>\n>  All information in this profile and the included repositories (according to GitHubâ€™s applicable terminology), including any text and graphic works, is provided for informational purposes only.\n> Any use of the information provided through this profile and/or any text or graphic works in the repositories in practice, without prior consent from the subject for conducting testing, falls under the scope of applicable law.\n> The author is not responsible for any possible damage caused by the provided materials, including any text or graphic works.\n> All text and graphic works, including links, are for informational purposes only and are intended solely to share knowledge in product security.\n'

          if ! grep -qF Disclaimer" <<< "$CONTENT"; then
            CONTENT="${CONTENT}${NOTICE}"
          fi

          printf '%s\n\n---\n\n Certificates\n\n%s\n' "$CONTENT" "$TABLE" > README.md

      - name: Commit changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Update certificates table from YAML"
          file_pattern: README.md
