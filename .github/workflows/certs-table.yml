name: Build certs table

on:
  push:
    branches:
      - master
    paths:
      - 'certs.yaml'

permissions:
  contents: write

jobs:
  build-table:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate Markdown table from YAML
        id: table
        uses: gazab/create-markdown-table@v1
        with:
          file: ./certs.yaml
          columns: '["ContentId","Area","PageTitle","MetaDescription"]'

      - name: Update README with notice and table
        run: |
          TABLE="${{ steps.table.outputs.table }}"
          CONTENT=$(cat README.md)

          NOTICE=$(cat << 'EOF'

          > ### Disclaimer
          >
          > ##### All information in this profile and the included repositories (according to GitHubâ€™s applicable terminology), including any text and graphic works, is provided for informational purposes only.
          > ##### Any use of the information provided through this profile and/or any text or graphic works in the repositories in practice, without prior consent from the subject for conducting testing, falls under the scope of applicable law.
          > ##### The author is not responsible for any possible damage caused by the provided materials, including any text or graphic works.
          > ##### All text and graphic works, including links, are for informational purposes only and are intended solely to share knowledge in product security.
          EOF
          )

          if ! grep -q "### Disclaimer" <<< "$CONTENT"; then
            CONTENT="${CONTENT}${NOTICE}"
          fi

          cat > README.md << EOF
          ${CONTENT}

          ---

          ### Certificates

          ${TABLE}
          EOF

      - name: Commit changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ðŸ¤– Update certificates table from YAML"
          file_pattern: README.md
