name: Update commits per year (all repos)

on:
  schedule:
    - cron: '0 3 * * *'   # каждый день в 03:00 UTC
  workflow_dispatch:

jobs:
  update-commits:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Count commits
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          python3 - << 'EOF'
          import os
          import json
          import requests
          from datetime import datetime

          token = os.environ["GH_PAT"]
          user = "geminishkv"  # Твой username
          headers = {"Authorization": f"token {token}", "Accept": "application/vnd.github.v3+json"}

          def get_repos():
              url = f"https://api.github.com/user/repos?per_page=100&type=owner"
              resp = requests.get(url, headers=headers)
              if resp.status_code != 200:
                  raise ValueError(f"Repos error: {resp.status_code}")
              return [r["name"] for r in resp.json()]

          def count_commits_repo(repo, year):
              since = f"{year}-01-01T00:00:00Z"
              until = f"{year}-12-31T23:59:59Z"
              url = f"https://api.github.com/repos/{user}/{repo}/commits"
              params = {"since": since, "until": until, "per_page": 100}
              resp = requests.get(url, headers=headers, params=params)
              if resp.status_code == 404:
                  return 0  # Repo приват/удален
              resp.raise_for_status()
              commits = resp.json()
              count = len(commits)
              # Paginate если много
              while "next" in resp.links:
                  resp = requests.get(resp.links["next"]["url"], headers=headers)
                  resp.raise_for_status()
                  count += len(resp.json())
              return count

          repos = get_repos()
          commits_2025 = sum(count_commits_repo(repo, 2025) for repo in repos)
          commits_2026 = sum(count_commits_repo(repo, 2026) for repo in repos)

          data = {"commits_2025": commits_2025, "commits_2026": commits_2026}
          with open("commits.json", "w") as f:
              json.dump(data, f, indent=2)
          print(f"2025: {commits_2025}, 2026: {commits_2026}")
          EOF

      - name: Commit changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Update yearly commits stats (all repos)"
          file_pattern: commits.json
