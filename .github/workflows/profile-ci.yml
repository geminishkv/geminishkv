name: Profile CI

on:
  push:
    branches:
      - master
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-commits:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Sync with remote
        run: |
          git config pull.rebase true
          git pull origin master

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install requests
        run: pip install requests

      - name: Count commits all repos
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          python3 - << 'EOF'
          import os
          import json
          import requests

          token = os.environ["GH_PAT"]
          user = "geminishkv"
          headers = {
              "Authorization": f"token {token}",
              "Accept": "application/vnd.github.v3+json",
          }

          def get_repos():
              repos = []
              url = "https://api.github.com/user/repos?per_page=100&type=owner"
              while url:
                  resp = requests.get(url, headers=headers)
                  resp.raise_for_status()
                  repos.extend([r["name"] for r in resp.json()])
                  url = resp.links.get("next", {}).get("url")
              return repos

          def count_commits_year(year):
              total = 0
              for repo in get_repos():
                  since = f"{year}-01-01T00:00:00Z"
                  until = f"{year}-12-31T23:59:59Z"
                  u = f"https://api.github.com/repos/{user}/{repo}/commits"
                  params = {"since": since, "until": until, "per_page": 100}
                  resp = requests.get(u, headers=headers, params=params)
                  if resp.status_code == 404:
                      continue
                  resp.raise_for_status()
                  commits = resp.json()
                  cnt = len(commits)
                  next_url = resp.links.get("next", {}).get("url")
                  while next_url:
                      resp = requests.get(next_url, headers=headers)
                      resp.raise_for_status()
                      cnt += len(resp.json())
                      next_url = resp.links.get("next", {}).get("url")
                  total += cnt
              return total

          commits_2025 = count_commits_year(2025)
          commits_2026 = count_commits_year(2026)

          data = {
              "commits_2025": commits_2025,
              "commits_2026": commits_2026,
              "updated": "2026-02-17",
          }

          with open("commits.json", "w") as f:
              json.dump(data, f, indent=2)

          print(f"2025: {commits_2025} | 2026: {commits_2026} | Repos: {len(get_repos())}")
          EOF

      - name: Commit commits.json
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Update commits stats ({{ github.ref_name }})"
          file_pattern: commits.json

  build-certs:
    runs-on: ubuntu-latest
    needs: update-commits

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Sync with remote
        run: |
          git config pull.rebase true
          git pull origin master

      - name: Generate Markdown table from YAML
        id: table
        uses: gazab/create-markdown-table@v1
        with:
          file: ./certs.yaml
          columns: '["ContentId","Area","PageTitle","MetaDescription"]'

      - name: Update readme
        run: |
          TABLE="${{ steps.table.outputs.table }}"
          CONTENT="$(cat readme.md)"

          NOTICE=$'\n> ### Disclaimer\n>\n> All information in this profile and the included repositories (according to GitHubâ€™s applicable terminology), including any text and graphic works, is provided for informational purposes only.\n> Any use of the information provided through this profile and/or any text or graphic works in the repositories in practice, without prior consent from the subject for conducting testing, falls under the scope of applicable law.\n> The author is not responsible for any possible damage caused by the provided materials, including any text or graphic works.\n> All text and graphic works, including links, are for informational purposes only and are intended solely to share knowledge in product security.\n'

          if ! grep -qF "### Disclaimer" <<< "$CONTENT"; then
            CONTENT="${CONTENT}${NOTICE}"
          fi

          CONTENT="$(printf '%s' "$CONTENT" | perl -0777 -pe 's/### Certificates[\\s\\S]*$//')"

          printf '%s\n\n---\n\n### Certificates\n\n%s\n' "$CONTENT" "$TABLE" > readme.md

      - name: Commit readme
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Update certificates table from YAML"
          file_pattern: readme.md
